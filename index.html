<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerenciador de Fiados com Pagamentos Agrupados</title>
<style>
  body {
    max-width: 700px;
    margin: 30px auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #fff8f0;
    color: #4a2c00;
    padding: 20px;
    line-height: 1.5;
  }
  h1 {
    text-align: center;
    color: #d2691e;
    margin-bottom: 25px;
  }
  section {
    background: #ffe5b4;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0 10px rgba(210,105,30,0.3);
    margin-bottom: 35px;
  }
  section h2 {
    font-weight: 700;
    border-bottom: 2px solid #d2691e;
    padding-bottom: 8px;
    margin-bottom: 18px;
    color: #a0522d;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  section h2 button {
    background-color: #a0522d;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  section h2 button:hover {
    background-color: #7b3b12;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  li {
    background: #fff2d1;
    border-radius: 8px;
    padding: 14px 16px;
    box-shadow: 0 0 8px rgba(210,105,30,0.3);
    margin-bottom: 12px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
  }
  .info {
    flex-grow: 1;
    min-width: 220px;
    cursor: default;
  }
  .info strong {
    color: #8b4513;
    font-size: 1.1em;
  }
  .info em {
    color: #6e3f00;
    font-style: italic;
  }
  .status {
    font-weight: 700;
    min-width: 140px;
    text-align: center;
  }
  .status.pago {
    color: green;
  }
  .status.parcial {
    color: #b36b00;
  }
  button.action-btn {
    background-color: #a0522d;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button.action-btn:hover {
    background-color: #7b3b12;
  }
  button.delete-btn {
    background-color: #c0392b;
  }
  button.delete-btn:hover {
    background-color: #8e261c;
  }
  .subtotal, .total {
    font-weight: 700;
    font-size: 1.2em;
    margin-top: 10px;
    color: #a0522d;
    user-select: text;
    text-align: right;
  }
  /* Modal */
  #formModal {
    display: none;
    position: fixed;
    top:0; left:0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.35);
    justify-content: center;
    align-items: center;
    z-index: 1100;
  }
  #formModal form {
    background: #fff8f0;
    padding: 25px 30px;
    border-radius: 10px;
    width: 100%;
    max-width: 450px;
    box-shadow: 0 0 15px rgba(210,105,30,0.7);
  }
  #formModal h3 {
    margin-bottom: 20px;
    color: #a0522d;
    text-align: center;
  }
  .input-group {
    margin-bottom: 18px;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #8b4513;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #a0522d;
    font-size: 1em;
  }
  #formModal .btn-row {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  #formModal button {
    padding: 8px 16px;
    font-weight: 700;
    border-radius: 6px;
    border: none;
    cursor: pointer;
  }
  #cancelBtn {
    background: #ccc;
    color: #333;
  }
  #cancelBtn:hover {
    background: #aaa;
  }
  #saveBtn {
    background: #a0522d;
    color: white;
  }
  #saveBtn:hover {
    background: #7b3b12;
  }
  @media (max-width: 520px) {
    li {
      flex-direction: column;
      align-items: flex-start;
    }
    .status {
      min-width: auto;
      width: 100%;
      text-align: left;
    }
    button.action-btn {
      width: 100%;
    }
  }
</style>
</head>
<body>

<h1>üìã Lista de Fiados <br>üç¨ Juju Doces üßÅ</h1>

<section id="fiadosPendentesSection">
  <h2>
    Fiados Pendentes
    <button id="btnAddFiado">‚ûï Adicionar Fiado</button>
  </h2>
  <ul id="fiadosPendentesList">
    <!-- Itens fiados pendentes -->
  </ul>
  <p class="subtotal" id="subtotalFiados">üßæ Subtotal: R$ 0,00</p>
</section>

<section id="pagamentosRealizadosSection">
  <h2>
    ‚úÖ Pagamentos Realizados (Agrupados por Nome)
    <button id="btnAddPagamento">‚ûï Adicionar Pagamento Manual</button>
  </h2>
  <ul id="pagamentosRealizadosList">
    <!-- Itens pagamentos -->
  </ul>
  <p class="total" id="totalRecebido">üíµ Total Recebido: R$ 0,00</p>
</section>

<!-- Modal para adicionar/editar -->
<div id="formModal">
  <form id="formEntrada">
    <h3 id="formTitle">Adicionar Entrada</h3>

    <div class="input-group">
      <label for="nomeInput">Nome</label>
      <input type="text" id="nomeInput" required autocomplete="off" />
    </div>
    <div class="input-group">
      <label for="valorInput">Valor (R$)</label>
      <input type="number" id="valorInput" min="0.01" step="0.01" required />
    </div>
    <div class="input-group">
      <label for="obsInput">Observa√ß√£o (opcional)</label>
      <input type="text" id="obsInput" placeholder="Ex: 2 trufas + 1 morango" autocomplete="off" />
    </div>

    <div class="btn-row">
      <button type="button" id="cancelBtn">Cancelar</button>
      <button type="submit" id="saveBtn">Salvar</button>
    </div>
  </form>
</div>

<script>
  let fiadosPendentes = [];
  let pagamentosRealizados = [];

  const fiadosPendentesList = document.getElementById("fiadosPendentesList");
  const pagamentosRealizadosList = document.getElementById("pagamentosRealizadosList");
  const subtotalFiados = document.getElementById("subtotalFiados");
  const totalRecebido = document.getElementById("totalRecebido");

  const btnAddFiado = document.getElementById("btnAddFiado");
  const btnAddPagamento = document.getElementById("btnAddPagamento");

  const formModal = document.getElementById("formModal");
  const formEntrada = document.getElementById("formEntrada");
  const formTitle = document.getElementById("formTitle");
  const nomeInput = document.getElementById("nomeInput");
  const valorInput = document.getElementById("valorInput");
  const obsInput = document.getElementById("obsInput");
  const cancelBtn = document.getElementById("cancelBtn");

  let modo = ""; // "fiado" ou "pagamento" ou "editar-fiado" ou "editar-pagamento"
  let editIndex = null;

  function formatarValor(valor) {
    return valor.toFixed(2).replace('.', ',');
  }

  // Atualiza o status de pagamento ("Pago" ou "Pago parcial") baseado no fiado pendente e no pagamento acumulado
  function calcularStatusPagamento(nome) {
    const fiado = fiadosPendentes.find(f => f.nome.toLowerCase() === nome.toLowerCase());
    const pagamento = pagamentosRealizados.find(p => p.nome.toLowerCase() === nome.toLowerCase());

    if (!pagamento) return "";

    if (!fiado) {
      // Se n√£o deve mais nada, est√° pago
      return "Pago";
    }

    const valorDevido = fiado.valor;
    const valorPago = pagamento.valor;

    if (valorPago >= valorDevido) return "Pago";
    if (valorPago < valorDevido) return "Pago parcial";

    return "";
  }

  // Renderiza as listas de fiados pendentes e pagamentos realizados
  function renderizar() {
    // Render fiados pendentes
    if (fiadosPendentes.length === 0) {
      fiadosPendentesList.innerHTML = '<li style="font-style:italic; color:#a0522d;">Nenhum fiado pendente.</li>';
    } else {
      fiadosPendentesList.innerHTML = "";
      fiadosPendentes.forEach((item, i) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="info">
            <strong>${item.nome}</strong> ‚Äì R$ ${formatarValor(item.valor)} ${item.obs ? `<em>${item.obs}</em>` : ''}
          </div>
          <button class="action-btn" title="Registrar pagamento parcial">Registrar pagamento</button>
          <button class="action-btn" title="Editar fiado">‚úèÔ∏è</button>
          <button class="action-btn delete-btn" title="Excluir fiado">üóëÔ∏è</button>
        `;

        li.querySelector("button[title='Registrar pagamento parcial']").onclick = () => registrarPagamento(i);
        li.querySelector("button[title='Editar fiado']").onclick = () => abrirFormulario("editar-fiado", i);
        li.querySelector("button[title='Excluir fiado']").onclick = () => {
          if (confirm(`Excluir fiado de ${item.nome}?`)) {
            // Remove fiado pendente
            fiadosPendentes.splice(i, 1);

            // Remove pagamentos realizados relacionados
            pagamentosRealizados = pagamentosRealizados.filter(p => p.nome.toLowerCase() !== item.nome.toLowerCase());

            renderizar();
          }
        };

        fiadosPendentesList.appendChild(li);
      });
    }

    subtotalFiados.textContent = `üßæ Subtotal: R$ ${formatarValor(fiadosPendentes.reduce((acc, i) => acc + i.valor, 0))}`;

    // Render pagamentos realizados
    if (pagamentosRealizados.length === 0) {
      pagamentosRealizadosList.innerHTML = '<li style="font-style:italic; color:#a0522d;">Nenhum pagamento realizado.</li>';
    } else {
      pagamentosRealizadosList.innerHTML = "";
      pagamentosRealizados.forEach((item, i) => {
        const statusAtual = calcularStatusPagamento(item.nome);
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="info">
            <strong>${item.nome}</strong> ‚Äì R$ ${formatarValor(item.valor)} ${item.obs ? `<em>${item.obs}</em>` : ''}
          </div>
          <div class="status ${statusAtual === "Pago parcial" ? "parcial" : statusAtual === "Pago" ? "pago" : ""}">${statusAtual || "Pago"}</div>
          <button class="action-btn" title="Editar pagamento">‚úèÔ∏è</button>
          <button class="action-btn delete-btn" title="Excluir pagamento">üóëÔ∏è</button>
        `;

        li.querySelector("button[title='Editar pagamento']").onclick = () => abrirFormulario("editar-pagamento", i);
        li.querySelector("button[title='Excluir pagamento']").onclick = () => {
          if (confirm(`Excluir pagamento de ${item.nome} - R$ ${formatarValor(item.valor)}?`)) {
            pagamentosRealizados.splice(i, 1);
            renderizar();
          }
        };

        pagamentosRealizadosList.appendChild(li);
      });
    }

    totalRecebido.textContent = `üíµ Total Recebido: R$ ${formatarValor(pagamentosRealizados.reduce((acc, i) => acc + i.valor, 0))}`;
  }

  // Abre modal para adicionar ou editar entradas
  function abrirFormulario(novoModo, index = null) {
    modo = novoModo;
    editIndex = index;
    formModal.style.display = "flex";

    if (modo === "fiado") {
      formTitle.textContent = "Adicionar Fiado (soma valores se j√° existir)";
      nomeInput.value = "";
      valorInput.value = "";
      obsInput.value = "";
    } else if (modo === "pagamento") {
      formTitle.textContent = "Adicionar Pagamento Manual (soma ao pagamento existente)";
      nomeInput.value = "";
      valorInput.value = "";
      obsInput.value = "";
    } else if (modo === "editar-fiado" && editIndex !== null) {
      formTitle.textContent = "Editar Fiado";
      const item = fiadosPendentes[editIndex];
      nomeInput.value = item.nome;
      valorInput.value = item.valor;
      obsInput.value = item.obs || "";
    } else if (modo === "editar-pagamento" && editIndex !== null) {
      formTitle.textContent = "Editar Pagamento";
      const item = pagamentosRealizados[editIndex];
      nomeInput.value = item.nome;
      valorInput.value = item.valor;
      obsInput.value = item.obs || "";
    }
  }

  function fecharFormulario() {
    formModal.style.display = "none";
    editIndex = null;
    modo = "";
    formEntrada.reset();
  }

  // Bot√µes abrir modal
  btnAddFiado.onclick = () => abrirFormulario("fiado");
  btnAddPagamento.onclick = () => abrirFormulario("pagamento");
  cancelBtn.onclick = fecharFormulario;

  // Form submit (adicionar ou editar)
  formEntrada.addEventListener("submit", e => {
    e.preventDefault();

    const nome = nomeInput.value.trim();
    const valor = parseFloat(valorInput.value);
    const obs = obsInput.value.trim();

    if (!nome) {
      alert("Informe o nome.");
      nomeInput.focus();
      return;
    }
    if (isNaN(valor) || valor <= 0) {
      alert("Informe um valor v√°lido maior que zero.");
      valorInput.focus();
      return;
    }

    if (modo === "fiado") {
      // Se j√° existe fiado pendente com esse nome, soma valor e concatena observa√ß√£o
      const idxFiado = fiadosPendentes.findIndex(f => f.nome.toLowerCase() === nome.toLowerCase());
      if (idxFiado >= 0) {
        fiadosPendentes[idxFiado].valor += valor;
        if (obs) {
          fiadosPendentes[idxFiado].obs = fiadosPendentes[idxFiado].obs ? fiadosPendentes[idxFiado].obs + " + " + obs : obs;
        }
      } else {
        fiadosPendentes.push({ nome, valor, obs });
      }
    } else if (modo === "pagamento") {
      // Soma pagamento a pagamento realizado j√° existente ou adiciona novo
      const idxPag = pagamentosRealizados.findIndex(p => p.nome.toLowerCase() === nome.toLowerCase());
      if (idxPag >= 0) {
        pagamentosRealizados[idxPag].valor += valor;
        if (obs) {
          pagamentosRealizados[idxPag].obs = pagamentosRealizados[idxPag].obs ? pagamentosRealizados[idxPag].obs + " + " + obs : obs;
        }
      } else {
        pagamentosRealizados.push({ nome, valor, obs });
      }

      // Atualiza fiado pendente
      const idxFiado = fiadosPendentes.findIndex(f => f.nome.toLowerCase() === nome.toLowerCase());
      if (idxFiado >= 0) {
        fiadosPendentes[idxFiado].valor -= valor;
        if (fiadosPendentes[idxFiado].valor <= 0) {
          // Se quitou tudo, remove fiado
          fiadosPendentes.splice(idxFiado, 1);
        }
      }
    } else if (modo === "editar-fiado" && editIndex !== null) {
      fiadosPendentes[editIndex] = { nome, valor, obs };
    } else if (modo === "editar-pagamento" && editIndex !== null) {
      pagamentosRealizados[editIndex] = { nome, valor, obs };
    }

    fecharFormulario();
    renderizar();
  });

  // Registrar pagamento parcial diretamente na lista de fiados pendentes
  function registrarPagamento(index) {
    const fiado = fiadosPendentes[index];

    let valorPagoStr = prompt(`Registrar pagamento para ${fiado.nome}:\nValor devido: R$ ${formatarValor(fiado.valor)}\nDigite o valor pago agora:`, "");
    if (valorPagoStr === null) return; // Cancelou

    let valorPago = parseFloat(valorPagoStr.replace(",", "."));
    if (isNaN(valorPago) || valorPago <= 0) {
      alert("Valor inv√°lido!");
      return;
    }
    if (valorPago > fiado.valor) {
      alert("Valor pago n√£o pode ser maior que o valor devido.");
      return;
    }

    // Atualiza ou adiciona pagamento realizado
    const idxPag = pagamentosRealizados.findIndex(p => p.nome.toLowerCase() === fiado.nome.toLowerCase());
    if (idxPag >= 0) {
      pagamentosRealizados[idxPag].valor += valorPago;
    } else {
      pagamentosRealizados.push({ nome: fiado.nome, valor: valorPago, obs: "" });
    }

    // Atualiza fiado pendente
    fiado.valor -= valorPago;
    if (fiado.valor <= 0) {
      fiadosPendentes.splice(index, 1);
    }

    renderizar();
  }

  // Inicializa com renderiza√ß√£o vazia
  renderizar();
</script>

</body>
</html>
