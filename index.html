<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gerenciador de Fiados com Pagamentos Agrupados</title>
<style>
  body {
    max-width: 700px;
    margin: 30px auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #fff8f0;
    color: #4a2c00;
    padding: 20px;
    line-height: 1.5;
  }
  h1 {
    text-align: center;
    color: #d2691e;
    margin-bottom: 25px;
  }
  section {
    background: #ffe5b4;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 0 10px rgba(210,105,30,0.3);
    margin-bottom: 35px;
  }
  section h2 {
    font-weight: 700;
    border-bottom: 2px solid #d2691e;
    padding-bottom: 8px;
    margin-bottom: 18px;
    color: #a0522d;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  section h2 button {
    background-color: #a0522d;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    transition: background-color 0.3s ease;
  }
  section h2 button:hover {
    background-color: #7b3b12;
  }
  ul {
    list-style: none;
    padding-left: 0;
  }
  li {
    background: #fff2d1;
    border-radius: 8px;
    padding: 14px 16px;
    box-shadow: 0 0 8px rgba(210,105,30,0.3);
    margin-bottom: 12px;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
  }
  .info {
    flex-grow: 1;
    min-width: 220px;
    cursor: default;
  }
  .info strong {
    color: #8b4513;
    font-size: 1.1em;
  }
  .info em {
    color: #6e3f00;
    font-style: italic;
  }
  .status {
    font-weight: 700;
    min-width: 140px;
    text-align: center;
  }
  .status.pago {
    color: green;
  }
  .status.parcial {
    color: #b36b00;
  }
  button.action-btn {
    background-color: #a0522d;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button.action-btn:hover {
    background-color: #7b3b12;
  }
  button.delete-btn {
    background-color: #c0392b;
  }
  button.delete-btn:hover {
    background-color: #8e261c;
  }
  .subtotal, .total {
    font-weight: 700;
    font-size: 1.2em;
    margin-top: 10px;
    color: #a0522d;
    user-select: text;
    text-align: right;
  }
  /* Modal */
  #formModal {
    display: none;
    position: fixed;
    top:0; left:0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.35);
    justify-content: center;
    align-items: center;
    z-index: 1100;
  }
  #formModal form {
    background: #fff8f0;
    padding: 25px 30px;
    border-radius: 10px;
    width: 100%;
    max-width: 450px;
    box-shadow: 0 0 15px rgba(210,105,30,0.7);
  }
  #formModal h3 {
    margin-bottom: 20px;
    color: #a0522d;
    text-align: center;
  }
  .input-group {
    margin-bottom: 18px;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #8b4513;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #a0522d;
    font-size: 1em;
  }
  #formModal .btn-row {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  #formModal button {
    padding: 8px 16px;
    font-weight: 700;
    border-radius: 6px;
    border: none;
    cursor: pointer;
  }
  #cancelBtn {
    background: #ccc;
    color: #333;
  }
  #cancelBtn:hover {
    background: #aaa;
  }
  #saveBtn {
    background: #a0522d;
    color: white;
  }
  #saveBtn:hover {
    background: #7b3b12;
  }
  @media (max-width: 520px) {
    li {
      flex-direction: column;
      align-items: flex-start;
    }
    .status {
      min-width: auto;
      width: 100%;
      text-align: left;
    }
    button.action-btn {
      width: 100%;
    }
  }
</style>
</head>
<body>

<h1>üìã Lista de Fiados <br>üç¨ Juju Doces üßÅ</h1>

<section id="fiadosPendentesSection">
  <h2>
    Fiados Pendentes
    <button id="btnAddFiado">‚ûï Adicionar Fiado</button>
  </h2>
  <ul id="fiadosPendentesList">
    <!-- Itens fiados pendentes -->
  </ul>
  <p class="subtotal" id="subtotalFiados">üßæ Subtotal: R$ 0,00</p>
</section>

<section id="pagamentosRealizadosSection">
  <h2>
    ‚úÖ Pagamentos Realizados (Agrupados por Nome)
    <button id="btnAddPagamento">‚ûï Adicionar Pagamento Manual</button>
  </h2>
  <ul id="pagamentosRealizadosList">
    <!-- Itens pagamentos -->
  </ul>
  <p class="total" id="totalRecebido">üíµ Total Recebido: R$ 0,00</p>
</section>

<!-- Modal para adicionar/editar -->
<div id="formModal">
  <form id="formEntrada">
    <h3 id="formTitle">Adicionar Entrada</h3>

    <div class="input-group">
      <label for="nomeInput">Nome</label>
      <input type="text" id="nomeInput" required autocomplete="off" />
    </div>
    <div class="input-group">
      <label for="valorInput">Valor (R$)</label>
      <input type="number" id="valorInput" min="0.01" step="0.01" required />
    </div>
    <div class="input-group">
      <label for="obsInput">Observa√ß√£o (opcional)</label>
      <input type="text" id="obsInput" placeholder="Ex: 2 trufas + 1 morango" autocomplete="off" />
    </div>

    <div class="btn-row">
      <button type="button" id="cancelBtn">Cancelar</button>
      <button type="submit" id="saveBtn">Salvar</button>
    </div>
  </form>
</div>

<script>
  // Chaves para localStorage
  const STORAGE_FIADOS_KEY = "fiadosPendentes";
  const STORAGE_PAGAMENTOS_KEY = "pagamentosRealizados";

  // Carrega os dados do localStorage, ou inicializa arrays vazios
  let fiadosPendentes = JSON.parse(localStorage.getItem(STORAGE_FIADOS_KEY)) || [];
  let pagamentosRealizados = JSON.parse(localStorage.getItem(STORAGE_PAGAMENTOS_KEY)) || [];

  // Elementos DOM
  const fiadosPendentesList = document.getElementById("fiadosPendentesList");
  const pagamentosRealizadosList = document.getElementById("pagamentosRealizadosList");
  const subtotalFiados = document.getElementById("subtotalFiados");
  const totalRecebido = document.getElementById("totalRecebido");
  const btnAddFiado = document.getElementById("btnAddFiado");
  const btnAddPagamento = document.getElementById("btnAddPagamento");
  const formModal = document.getElementById("formModal");
  const formEntrada = document.getElementById("formEntrada");
  const formTitle = document.getElementById("formTitle");
  const nomeInput = document.getElementById("nomeInput");
  const valorInput = document.getElementById("valorInput");
  const obsInput = document.getElementById("obsInput");
  const cancelBtn = document.getElementById("cancelBtn");

  let modo = ""; // "fiado", "pagamento", "editar-fiado", "editar-pagamento"
  let editIndex = null;

  // Fun√ß√£o para formatar valor monet√°rio
  function formatarValor(valor) {
    return valor.toFixed(2).replace('.', ',');
  }

  // Salvar dados no localStorage
  function salvarDados() {
    localStorage.setItem(STORAGE_FIADOS_KEY, JSON.stringify(fiadosPendentes));
    localStorage.setItem(STORAGE_PAGAMENTOS_KEY, JSON.stringify(pagamentosRealizados));
  }

  // Calcula status de pagamento: "Pago", "Pago parcial" ou ""
  function calcularStatusPagamento(nome) {
    const fiado = fiadosPendentes.find(f => f.nome.toLowerCase() === nome.toLowerCase());
    const pagamento = pagamentosRealizados.find(p => p.nome.toLowerCase() === nome.toLowerCase());
    if (!pagamento) return "";
    if (!fiado) return "Pago";
    if (pagamento.valor >= fiado.valor) return "Pago";
    if (pagamento.valor < fiado.valor) return "Pago parcial";
    return "";
  }

  // Renderiza as listas na tela
  function renderizar() {
    // Fiados Pendentes
    if (fiadosPendentes.length === 0) {
      fiadosPendentesList.innerHTML = '<li style="font-style:italic; color:#a0522d;">Nenhum fiado pendente.</li>';
    } else {
      fiadosPendentesList.innerHTML = "";
      fiadosPendentes.forEach((item, i) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="info">
            <strong>${item.nome}</strong> ‚Äì R$ ${formatarValor(item.valor)} ${item.obs ? `<em>${item.obs}</em>` : ''}
          </div>
          <button class="action-btn" title="Registrar pagamento parcial">Registrar pagamento</button>
          <button class="action-btn" title="Editar fiado">‚úèÔ∏è</button>
          <button class="action-btn delete-btn" title="Excluir fiado">üóëÔ∏è</button>
        `;
        li.querySelector("button[title='Registrar pagamento parcial']").onclick = () => registrarPagamento(i);
        li.querySelector("button[title='Editar fiado']").onclick = () => abrirFormulario("editar-fiado", i);
        li.querySelector("button[title='Excluir fiado']").onclick = () => {
          if (confirm(`Excluir fiado de ${item.nome}?`)) {
            fiadosPendentes.splice(i, 1);
            pagamentosRealizados = pagamentosRealizados.filter(p => p.nome.toLowerCase() !== item.nome.toLowerCase());
            salvarDados();
            renderizar();
          }
        };
        fiadosPendentesList.appendChild(li);
      });
    }
    subtotalFiados.textContent = `üßæ Subtotal: R$ ${formatarValor(fiadosPendentes.reduce((acc, i) => acc + i.valor, 0))}`;

    // Pagamentos Realizados
    if (pagamentosRealizados.length === 0) {
      pagamentosRealizadosList.innerHTML = '<li style="font-style:italic; color:#a0522d;">Nenhum pagamento realizado.</li>';
    } else {
      pagamentosRealizadosList.innerHTML = "";
      pagamentosRealizados.forEach((item, i) => {
        const statusAtual = calcularStatusPagamento(item.nome);
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="info">
            <strong>${item.nome}</strong> ‚Äì R$ ${formatarValor(item.valor)} ${item.obs ? `<em>${item.obs}</em>` : ''}
          </div>
          <div class="status ${statusAtual === "Pago parcial" ? "parcial" : statusAtual === "Pago" ? "pago" : ""}">${statusAtual || "Pago"}</div>
          <button class="action-btn" title="Editar pagamento">‚úèÔ∏è</button>
          <button class="action-btn delete-btn" title="Excluir pagamento">üóëÔ∏è</button>
        `;
        li.querySelector("button[title='Editar pagamento']").onclick = () => abrirFormulario("editar-pagamento", i);
        li.querySelector("button[title='Excluir pagamento']").onclick = () => {
          if (confirm(`Excluir pagamento de ${item.nome} - R$ ${formatarValor(item.valor)}?`)) {
            pagamentosRealizados.splice(i, 1);
            salvarDados();
            renderizar();
          }
        };
        pagamentosRealizadosList.appendChild(li);
      });
    }
    totalRecebido.textContent = `üíµ Total Recebido: R$ ${formatarValor(pagamentosRealizados.reduce((acc, i) => acc + i.valor, 0))}`;
  }

  // Abre modal para adicionar/editar entradas
  function abrirFormulario(novoModo, index = null) {
    modo = novoModo;
    editIndex = index;
    formModal.style.display = "flex";

    if (modo === "fiado") {
      formTitle.textContent = "Adicionar Fiado (soma valores se j√° existir)";
      nomeInput.value = "";
      valorInput.value = "";
      obsInput.value = "";
    } else if (modo === "pagamento") {
      formTitle.textContent = "Adicionar Pagamento Manual (soma ao pagamento existente)";
      nomeInput.value = "";
      valorInput.value = "";
      obsInput.value = "";
    } else if (modo === "editar-fiado" && editIndex !== null) {
      formTitle.textContent = "Editar Fiado";
      const item = fiadosPendentes[editIndex];
      nomeInput.value = item.nome;
      valorInput.value = item.valor;
      obsInput.value = item.obs || "";
    } else if (modo === "editar-p
